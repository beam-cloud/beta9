# Default values for fluent-bit.

# kind -- DaemonSet or Deployment
kind: DaemonSet

# replicaCount -- Only applicable if kind=Deployment
replicaCount: 1

image:
  repository: cr.fluentbit.io/fluent/fluent-bit
  # Overrides the image tag whose default is {{ .Chart.AppVersion }}
  # Set to "-" to not use the default value
  tag:
  digest:
  pullPolicy: Always

env:
  - name: AWS_ACCESS_KEY_ID
    value:  AKIAZ6LIXV5GXAJOA3VM
  - name: AWS_SECRET_ACCESS_KEY
    value:  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

config:
  service: |
    [SERVICE]
        Daemon Off
        Flush {{ .Values.flush }}
        Log_Level {{ .Values.logLevel }}
        Parsers_File /fluent-bit/etc/parsers.conf
        Parsers_File /fluent-bit/etc/conf/custom_parsers.conf
        HTTP_Server On
        HTTP_Listen 0.0.0.0
        HTTP_Port {{ .Values.metricsPort }}
        Health_Check On

  customParsers: |
    [PARSER]
        Name        json-parser
        Format      json
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%SZ
        Time_Keep   On

  inputs: |
    [INPUT]
        Name              tail
        Tag               worker-logs
        Path              /var/log/worker/*.log
        Parser            json-parser
        Mem_Buf_Limit     100MB
        Skip_Long_Lines   Off
        Refresh_Interval  5

    
    [INPUT]
        Name tcp
        Tag events
        Port 8888

  outputs: |
    [OUTPUT]
        Name loki
        Match worker-logs
        Host loki.monitoring.svc.cluster.local
        Tenant_Id test
        labels job=fluent-bit
    
    [OUTPUT]
        name stdout
        match events
    
    [OUTPUT]
        name s3
        bucket tmp-bucket-s12dk
        match worker-logs
        use_put_object On
        total_file_size 1M
        upload_timeout 1m
    
    [OUTPUT]
        Name                es
        Match               worker-logs
        Host                beam-dev.es.us-east-1.aws.found.io
        Port                9243
        HTTP_User           elastic
        HTTP_Passwd         PHdCJRs383fVPRCV1Ws2ZZeK
        Logstash_Format     On
        Logstash_Prefix     test-logs-for-k3d-beam
        Retry_Limit         False
        Time_Key_Nanos      On
        Suppress_Type_Name  On
        Buffer_Size         False
        Trace_Error         On
        Replace_Dots        On
        tls                 On

volumeMounts:
  - name: config
    mountPath: /fluent-bit/etc/conf

daemonSetVolumes:
  - name: varlog
    hostPath:
      path: /var/log
  - name: varlibdockercontainers
    hostPath:
      path: /var/lib/docker/containers

daemonSetVolumeMounts:
  - name: varlog
    mountPath: /var/log
  - name: varlibdockercontainers
    mountPath: /var/lib/docker/containers
    readOnly: true

logLevel: info

extraPorts:
  - port: 8888
    containerPort: 8888
    protocol: TCP
    name: tcp