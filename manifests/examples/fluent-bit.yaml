apiVersion: v1
kind: Namespace
metadata:
  name: fluent-bit
---
apiVersion: v1
kind: Secret
metadata:
  namespace: fluent-bit
  name: fluent-bit
type: Opaque
stringData:
  ELASTICSEARCH_HOST: host
  ELASTICSEARCH_PORT: "9090"
  ELASTICSEARCH_USER: user
  ELASTICSEARCH_PASSWORD: password
  S3_BUCKET_NAME: s3-bucket-name
  AWS_ACCESS_KEY_ID: id
  AWS_SECRET_ACCESS_KEY: secret
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: fluent-bit
  namespace: fluent-bit
spec:
  chart: fluent-bit
  repo: https://fluent.github.io/helm-charts
  version: 0.42.0
  valuesContent: |
    envFrom:
    - secretRef:
        name: fluent-bit

    config:
      service: |
        [SERVICE]
            Flush        1
            Log_Level    info
            HTTP_Server  On
            HTTP_Listen  0.0.0.0
            HTTP_Port    2020

      customParsers: |
        [PARSER]
            Name        json-parser
            Format      json
            Time_Key    time
            Time_Format %Y-%m-%dT%H:%M:%SZ
            Time_Keep   On

      inputs: |
        [INPUT]
            Name              tail
            Tag               worker-logs
            Path              /var/log/worker/*.log
            Parser            json-parser
            Mem_Buf_Limit     100MB
            Skip_Long_Lines   Off
            Refresh_Interval  5
        
        [INPUT]
            Name  tcp
            Tag   events
            Port  8888
    
      outputs: |                
        [OUTPUT]
            Name  stdout
            Match *
     
        [OUTPUT]
            Name                es
            Match               worker-logs
            Host                ${ELASTICSEARCH_HOST}
            Port                ${ELASTICSEARCH_PORT}
            HTTP_User           ${ELASTICSEARCH_USER}
            HTTP_Passwd         ${ELASTICSEARCH_PASSWORD}
            Logstash_Format     On
            Logstash_Prefix     beta9-worker-logs
            Retry_Limit         False
            Time_Key_Nanos      On
            Suppress_Type_Name  On
            Buffer_Size         False
            Trace_Error         On
            Replace_Dots        On
            tls                 On
        
        [OUTPUT]
            Name      loki
            Match     worker-logs
            Host      loki.logging.svc.cluster.local
            Tenant_Id beta9
            Labels    job=fluent-bit
        
        [OUTPUT]
            Name            s3
            Bucket          ${S3_BUCKET_NAME}
            Match           worker-logs
            Use_Put_Object  On
            Total_File_Size 1M
            Upload_Timeout  1m

    volumeMounts:
      - name: config
        mountPath: /fluent-bit/etc/conf

    daemonSetVolumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers

    daemonSetVolumeMounts:
      - name: varlog
        mountPath: /var/log
      - name: varlibdockercontainers
        mountPath: /var/lib/docker/containers
        readOnly: true
