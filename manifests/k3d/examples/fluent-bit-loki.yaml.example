apiVersion: v1
kind: Namespace
metadata:
  name: fluent-bit
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  namespace: fluent-bit
spec:
  chart: fluent-bit
  repo: https://fluent.github.io/helm-charts
  version: 0.42.0
  valuesContent: |
    config:
      service: |
        [SERVICE]
            Daemon Off
            Flush {{ .Values.flush }}
            Log_Level {{ .Values.logLevel }}
            Parsers_File /fluent-bit/etc/parsers.conf
            Parsers_File /fluent-bit/etc/conf/custom_parsers.conf
            HTTP_Server On
            HTTP_Listen 0.0.0.0
            HTTP_Port {{ .Values.metricsPort }}
            Health_Check On

      customParsers: |
        [PARSER]
            Name        json-parser
            Format      json
            Time_Key    time
            Time_Format %Y-%m-%dT%H:%M:%SZ
            Time_Keep   On

      inputs: |
        [INPUT]
            Name              tail
            Tag               worker-logs
            Path              /var/log/worker/*.log
            Parser            json-parser
            Mem_Buf_Limit     100MB
            Skip_Long_Lines   Off
            Refresh_Interval  5

      outputs: |
        [OUTPUT]
            Name loki
            Match worker-logs
            Host ${LOKI_HOST}
            Tenant_Id ${LOKI_TENANT_ID}
            labels job=fluent-bit

    volumeMounts:
      - name: config
        mountPath: /fluent-bit/etc/conf

    daemonSetVolumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers

    daemonSetVolumeMounts:
      - name: varlog
        mountPath: /var/log
      - name: varlibdockercontainers
        mountPath: /var/lib/docker/containers
        readOnly: true