name: Auto Changelog PR

on:
  release:
    types: [published]
  workflow_dispatch: # Add this line to allow manual triggering

jobs:
  changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the Beta9 repo
        uses: actions/checkout@v3

      - name: Fetch the latest release data
        id: release
        uses: actions/github-script@v6
        with:
          script: |
            const release = context.payload.release;
            return {
              name: release.name,
              body: release.body,
              created_at: release.created_at
            };

      - name: Checkout beam-docs repo
        uses: actions/checkout@v3
        with:
          repository: slai-labs/beam-docs
          path: beam-docs
          token: ${{ secrets.BEAM_DOCS_PAT }}

      - name: Create new release file in beam-docs
        run: |
          cd beam-docs/v2/releases
          RELEASE_DATE=$(date -I)
          FILENAME="${RELEASE_DATE}.md"
          echo "# Release: ${{ steps.release.outputs.name }}" > $FILENAME
          echo "" >> $FILENAME
          echo "Release date: ${{ steps.release.outputs.created_at }}" >> $FILENAME
          echo "" >> $FILENAME
          echo "## Changelog" >> $FILENAME
          echo "${{ steps.release.outputs.body }}" >> $FILENAME

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "Add changelog for ${{ steps.release.outputs.name }}"
          git push origin main

      - name: Create pull request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.BEAM_DOCS_PAT }}
          commit-message: "Add changelog for ${{ steps.release.outputs.name }}"
          branch: auto-changelog
          title: "Changelog for ${{ steps.release.outputs.name }}"
          body: "This PR adds the changelog for ${{ steps.release.outputs.name }}."
          base: main
